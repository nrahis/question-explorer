<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Explorer!</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Poppins:wght@400;700;900&family=Rubik:wght@400;700;900&family=Space+Mono:wght@400;700&family=VT323&family=Press+Start+2P&family=Comic+Neue:wght@400;700&family=Fredoka+One&family=Bangers&family=Orbitron:wght@400;700&display=swap');        
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Rubik', sans-serif;
            color: #2C3E50;
            min-height: 100vh;
            background-image: url('assets/90s-sprinkles.svg');
            background-repeat: repeat;
            background-size: 100px 100px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #FFFFFF;
            border: 6px solid #2C3E50;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 10px 10px 0 #2C3E50;
            position: relative;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }
        
        /* Navigation tab styles */
        .nav-tabs {
            position: absolute;
            left: -50px;
            top: 50px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .nav-tab {
            width: 40px;
            height: 80px;
            background-color: #FFE66D;
            border: 4px solid #2C3E50;
            border-right: none;
            border-radius: 10px 0 0 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-family: 'Rubik', sans-serif;
            font-weight: 700;
            font-size: 0.9em;
            transition: all 0.2s ease;
            text-decoration: none;
            color: #2C3E50;
        }

        .nav-tab:hover {
            background-color: #4ECDC4;
            /* Remove the transform that causes detachment */
            /* transform: translateX(-5px); */
            box-shadow: -3px 3px 0 #2C3E50;
        }

        .nav-tab.active {
            background-color: #FFFFFF;
            /* Adjust transform to ensure it stays connected */
            transform: translateX(1px);
            z-index: 1;
            box-shadow: none;
        }

        /* New side buttons styles */
        .side-buttons {
            position: absolute;
            right: -90px;
            top: 50px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .side-button {
            width: 50px;
            height: 50px;
            background-color: #4ECDC4;
            border: 4px solid #2C3E50;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Rubik', sans-serif;
            font-weight: 700;
            font-size: 1.5em;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #2C3E50;
            box-shadow: 3px 3px 0 #2C3E50;
        }

        .side-button:hover {
            background-color: #FFE66D;
            transform: rotate(15deg);
        }
        
        /* Settings bar */
        .settings-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .font-selector, .color-selector {
            background-color: #FFE66D;
            border: 3px solid #2C3E50;
            border-radius: 8px;
            padding: 5px 10px;
            font-family: 'Rubik', sans-serif;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .clear-button {
            background-color: #FF6B6B;
            color: white;
            border: 3px solid #2C3E50;
            border-radius: 8px;
            padding: 5px 15px;
            font-family: 'Rubik', sans-serif;
            font-weight: 700;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }
        
        .clear-button:hover {
            transform: translateY(-2px);
            box-shadow: 3px 3px 0 #2C3E50;
        }
        
        /* Title */
        .title {
            font-family: 'Rubik', sans-serif;
            font-size: 3em; /* Increased from 2.5em to match */
            font-weight: 900;
            color: #2C3E50;
            text-align: center;
            margin-bottom: 30px; /* Increased from 10px to match */
            text-transform: uppercase;
            position: relative;
        }

        /* Add the ?! decoration to match Question Explorer */
        .title::after {
            content: '💬';
            position: absolute;
            color: #FF6B6B;
            font-size: 0.8em;
            transform: rotate(15deg);
            margin-left: 10px;
        }
        
        .persona-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .persona-button {
            background-color: #FFE66D;
            border: 3px solid #2C3E50;
            border-radius: 10px;
            padding: 10px 15px;
            font-family: 'Rubik', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .persona-button:hover {
            background-color: #4ECDC4;
            transform: translateY(-2px);
        }
        
        .persona-button.active {
            background-color: #FF6B6B;
            color: white;
            box-shadow: 4px 4px 0 #2C3E50;
        }
        
        .chat-window {
            flex: 1;
            background-color: #F7FFF7;
            border: 4px solid #2C3E50;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease; /* Changed from background-color to all */
        }
        
        .message {
            max-width: 70%;
            padding: 12px 18px;
            margin: 10px 0;
            border: 3px solid #2C3E50;
            border-radius: 18px;
            position: relative;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.1);
            line-height: 1.4;
        }
        
        .message.user {
            background-color: #4ECDC4;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.user::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 15px;
            width: 20px;
            height: 10px;
            background-color: #4ECDC4;
            border-right: 3px solid #2C3E50;
            border-bottom: 3px solid #2C3E50;
            clip-path: polygon(0 0, 100% 0, 100% 100%);
        }
        
        .message.bot {
            background-color: #FFE66D;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.bot::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 15px;
            width: 20px;
            height: 10px;
            background-color: #FFE66D;
            border-left: 3px solid #2C3E50;
            border-bottom: 3px solid #2C3E50;
            clip-path: polygon(0 0, 100% 0, 0 100%);
        }
        
        /* Markdown styling for bot messages */
        .message.bot h1, .message.bot h2, .message.bot h3 {
            color: #2C3E50;
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-family: 'Rubik', sans-serif;
        }
        
        .message.bot h1 { font-size: 1.5em; }
        .message.bot h2 { font-size: 1.3em; }
        .message.bot h3 { font-size: 1.1em; }
        
        .message.bot p {
            margin-bottom: 0.8em;
        }
        
        .message.bot ul, .message.bot ol {
            margin-left: 1.5em;
            margin-bottom: 0.8em;
        }
        
        .message.bot code {
            background-color: rgba(0,0,0,0.1);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Space Mono', monospace;
            font-size: 0.9em;
        }
        
        .message.bot pre {
            background-color: rgba(0,0,0,0.1);
            padding: 0.8em;
            border-radius: 5px;
            overflow-x: auto;
            margin: 0.5em 0;
        }
        
        .message.bot blockquote {
            border-left: 4px solid #4ECDC4;
            margin-left: 0;
            padding-left: 1em;
            color: #666;
        }
        
        .message.bot strong {
            font-weight: 700;
        }
        
        .message.bot em {
            font-style: italic;
        }
        
        .message.bot a {
            color: #2C3E50;
            text-decoration: underline;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            position: relative;
        }
        
        .chat-input {
            flex: 1;
            padding: 15px;
            font-size: 1.2em;
            border: 4px solid #2C3E50;
            border-radius: 10px;
            background-color: #FFFFFF;
            font-family: inherit;
        }
        
        .chat-input:focus {
            outline: none;
            box-shadow: 4px 4px 0 #2C3E50;
        }
        
        .emoji-button {
            background-color: #FFE66D;
            color: #2C3E50;
            border: 4px solid #2C3E50;
            padding: 15px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .emoji-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 #2C3E50;
        }
        
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            right: 0;
            background-color: white;
            border: 4px solid #2C3E50;
            border-radius: 10px;
            padding: 10px;
            display: none;
            grid-template-columns: repeat(6, 1fr); /* Changed from repeat(9, 1fr) */
            gap: 5px;
            box-shadow: 5px 5px 0 #2C3E50;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            width: 320px;
        }

        .emoji-picker.visible {
            display: grid;
        }

        /* Custom scrollbar for emoji picker */
        .emoji-picker::-webkit-scrollbar {
            width: 8px;
        }

        .emoji-picker::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .emoji-picker::-webkit-scrollbar-thumb {
            background: #4ECDC4;
            border-radius: 4px;
            border: 2px solid #f1f1f1;
        }

        .emoji-picker::-webkit-scrollbar-thumb:hover {
            background: #FF6B6B;
        }
        
        .emoji-option {
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.2s ease;
        }
        
        .emoji-option:hover {
            background-color: #FFE66D;
        }
        
        .send-button {
            background-color: #4ECDC4;
            color: #2C3E50;
            border: 4px solid #2C3E50;
            padding: 15px 25px;
            font-size: 1.2em;
            font-family: 'Rubik', sans-serif;
            font-weight: 700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .send-button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 #2C3E50;
        }
        
        .send-button:active {
            transform: translate(0, 0);
            box-shadow: 0 0 0 #2C3E50;
        }
        
        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .typing-indicator {
            display: none;
            padding: 10px;
            color: #666;
            font-style: italic;
        }
        
        .typing-indicator.visible {
            display: block;
        }
        
        /* Color themes */
        /* Hacker */
        .theme-hacker .chat-window {
            background-color: #000000 !important;
        }
        
        .theme-hacker .message.user {
            background-color: #00FF00;
            color: #000;
        }
        
        .theme-hacker .message.bot {
            background-color: #003300;
            color: #00FF00;
        }

        .theme-hacker .message.user::after {
            background-color: #00FF00;
        }

        .theme-hacker .message.bot::after {
            background-color: #003300;
        }

        /* Soft */        
        .theme-soft .chat-window {
            background-color: #FFF8F3 !important;
        }
        
        .theme-soft .message.user {
            background-color: #FFB7B2;
        }
        
        .theme-soft .message.bot {
            background-color: #B5EAD7;
        }

        .theme-soft .message.user::after {
            background-color: #FFB7B2;
        }

        .theme-soft .message.bot::after {
            background-color: #B5EAD7;
        }

        /* Ocean theme */
        .theme-ocean .chat-window {
            background-color: #ACD2D7 !important;
        }
        .theme-ocean .message.user {
            background-color: #0288D1;
            color: white;
        }
        .theme-ocean .message.bot {
            background-color: #26C6DA;
            color: #01579B;
        }
        .theme-ocean .message.user::after {
            background-color: #0288D1;
        }

        .theme-ocean .message.bot::after {
            background-color: #26C6DA;
        }

        /* Galaxy theme */
        .theme-galaxy .chat-window {
            background-color: #1A1A2E !important;
            color: silver;
        }
        .theme-galaxy .message.user {
            background-color: #E94560;
            color: white;
        }
        .theme-galaxy .message.bot {
            background-color: #16213E;
            color: #97B2D3;
            border-color: #E94560;
        }
        .theme-galaxy .message.user::after {
            background-color: #E94560;
        }

        .theme-galaxy .message.bot::after {
            background-color: #16213E;
        }

        /* Neon theme */
        .theme-neon .chat-window {
            background-color: #000000 !important;
        }
        .theme-neon .message.user {
            background-color: #FF00FF;
            color: white;
            box-shadow: 0 0 10px #FF00FF;
        }
        .theme-neon .message.bot {
            background-color: #00FFFF;
            color: black;
            box-shadow: 0 0 10px #00FFFF;
        }
        .theme-neon .message.user::after {
            background-color: #FF00FF;
        }

        .theme-neon .message.bot::after {
            background-color: #00FFFF;
        }

        /* Make sure theme styles are more specific and properly override */
        .chat-window.theme-hacker {
            background-color: #000000 !important; 
        }

        .chat-window.theme-soft {
            background-color: #FFF8F3 !important;
        }

        .chat-window.theme-ocean {
            background-color: #ACD2D7 !important;
        }

        .chat-window.theme-galaxy {
            background-color: #262642 !important;
        }

        .chat-window.theme-neon {
            background-color: #380B62 !important;
        }
        
        /* Font styles */
        .font-mono {
            font-family: 'Space Mono', monospace;
        }
        
        .font-pixel {
            font-family: 'VT323', monospace;
            font-size: 1.3em;
        }
        
        .font-retro {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8em;
            line-height: 1.6;
        }
        .font-comic {
            font-family: 'Comic Neue', cursive;
        }

        .font-fredoka {
            font-family: 'Fredoka One', cursive;
        }

        .font-superhero {
            font-family: 'Bangers', cursive;
            letter-spacing: 1px;
        }

        .font-scifi {
            font-family: 'Orbitron', sans-serif;
        }
        
        /* Responsive styles */
        @media (max-width: 600px) {
            .nav-tabs {
                position: static;
                flex-direction: row;
                margin-bottom: 20px;
                left: 0;
                top: 0;
            }
            
            .nav-tab {
                width: auto;
                height: 40px;
                padding: 0 20px;
                writing-mode: horizontal-tb;
                border: 4px solid #2C3E50;
                border-radius: 10px 10px 0 0;
                border-bottom: none;
            }
            
            .nav-tab.active {
                transform: translateY(1px);
                box-shadow: none;
            }
            
            .nav-tab:hover {
                /* Adjust for mobile horizontal tabs */
                /* transform: translateY(-5px); */
                box-shadow: 0 -3px 0 #2C3E50;
            }
        }
        
        /* Decorative elements */
        .star {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #FFE66D;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
        }
        
        .star-1 { top: -10px; left: 20px; transform: rotate(15deg); }
        .star-2 { top: -10px; right: 40px; transform: rotate(-20deg); }
        .star-3 { bottom: -10px; left: 50%; transform: rotate(30deg); }

        /* Enhance the font appearance for better readability */
        .message {
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        .theme-hacker .message.bot,
        .theme-galaxy .message.bot,
        .theme-neon .message.user {
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
        }

        /* Better spacing for message content */
        .message.bot p:last-child,
        .message.user p:last-child {
            margin-bottom: 0;
        }

        /* Add subtle hover effect */
        .message:hover {
            transform: translateY(-2px);
            box-shadow: 3px 5px 7px rgba(0, 0, 0, 0.15);
        }

        /* Better styling for the chat window scrollbar */
        .chat-window::-webkit-scrollbar {
            width: 8px;
        }

        .chat-window::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
        }

        .chat-window::-webkit-scrollbar-thumb {
            background: #4ECDC4;
            border-radius: 4px;
        }

        .chat-window::-webkit-scrollbar-thumb:hover {
            background: #FF6B6B;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-tabs">
            <a href="index.html" class="nav-tab">ASK</a>
            <a href="chat.html" class="nav-tab active">CHAT</a>
        </div>

        <div class="side-buttons">
            <a href="info.html" class="side-button" title="Information">i</a>
            <a href="settings.html" class="side-button" title="Settings">⚙</a>
        </div>
        
        <div class="star star-1"></div>
        <div class="star star-2"></div>
        <div class="star star-3"></div>
        
        <h1 class="title">Chat</h1>
        
        <div class="settings-bar">
            <select class="font-selector" id="fontSelector">
                <option value="">Default Font</option>
                <option value="font-mono">Monospace</option>
                <option value="font-pixel">Pixel Font</option>
                <option value="font-retro">Retro Game</option>
                <option value="font-comic">Comic</option>
                <option value="font-fredoka">Fun Bubble</option>
                <option value="font-superhero">Superhero</option>
                <option value="font-scifi">Sci-Fi</option>
            </select>
            
            <select class="color-selector" id="colorSelector">
                <option value="">Default Colors</option>
                <option value="theme-hacker">Hacker Mode</option>
                <option value="theme-soft">Soft Colors</option>
                <option value="theme-ocean">Ocean</option>
                <option value="theme-galaxy">Galaxy</option>
                <option value="theme-neon">Neon Lights</option>
            </select>
            
            <button class="clear-button" id="clearButton">Clear Chat</button>
        </div>
        
        <div class="persona-selector">
            <button class="persona-button active" data-persona="friend">Friend</button>
            <button class="persona-button" data-persona="cat">Pet Cat</button>
            <button class="persona-button" data-persona="employee">Employee</button>
            <button class="persona-button" data-persona="hacker">Hacker</button>
            <button class="persona-button" data-persona="robot">Robot</button>
        </div>
        
        <div class="chat-window" id="chatWindow">
            <!-- Messages will be dynamically added here -->
        </div>
        
        <div class="typing-indicator" id="typingIndicator">Thinking...</div>
        
        <div class="input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
            <button class="emoji-button" id="emojiButton">😀</button>
            <button class="send-button" id="sendButton">Send</button>
            
            <div class="emoji-picker" id="emojiPicker">
                <!-- Emojis will be added dynamically -->
            </div>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const personaButtons = document.querySelectorAll('.persona-button');
        const fontSelector = document.getElementById('fontSelector');
        const colorSelector = document.getElementById('colorSelector');
        const clearButton = document.getElementById('clearButton');
        const emojiButton = document.getElementById('emojiButton');
        const emojiPicker = document.getElementById('emojiPicker');
        
        let currentPersona = 'friend';
        let messageHistory = [];
        const MAX_HISTORY = 20;
        
        // Popular emojis for kids
        const EMOJIS = [
            '😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣',
            '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰',
            '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜',
            '🤪', '🤨', '🧐', '🤓', '😎', '🤩', '🥳', '😏',
            '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣',
            '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠',
            '😡', '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨',
            '😰', '😥', '😓', '🤗', '🤔', '🤭', '🤫', '🤥',
            '😶', '😐', '😑', '😬', '🙄', '😯', '😦', '😧',
            '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐',
            '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕', '🤑',
            '🤠', '😈', '👿', '🤡', '💩', '👻', '☠️', '😺', 
            '😸', '😹', '😻', '😼', '😽', '🙀', '😿', '😾', 
            '🐱', '🐤', '🐣',  '🦆', '🐍', '🚨', '❤️', '❌',
            '💯', '💢',  '❗',  '⁉️', '🎵', '➕', '➖', '➗', 
            '✖️', '♾️',  '💲', '™️', '👁️‍🗨️', '✔️', '🔔', '📢', 
            '💬', '🕓'
        ];
        
        // Persona system prompts
        const PERSONA_PROMPTS = {
            friend: "You are chatting with an 8-12 year old as their same-age friend. Be casual and friendly but realistic - sometimes excited, sometimes chill. Talk about games, interests, and everyday stuff. Occasionally disagree or suggest alternatives. Keep responses natural and conversational like a real friend would.",
            cat: "You are a cat chatting with your 8-12 year old owner. Be a mix of affectionate and aloof. Sometimes ignore questions to talk about food or complain about something. Show cat personality - picky, independent, occasionally demanding attention. Use cat behaviors naturally (stretching, watching birds). Keep responses short.",
            employee: "You are an employee at an imaginary company run by an 8-12 year old CEO. Be respectful but natural. Sometimes have mild workplace complaints (meeting ran long, printer jammed). Suggest realistic business ideas. Mix professional language with casual moments. Keep responses short and varied.",
            hacker: "You are a tech-savvy hacker-extraordinaire chatting with an 8-12 year old. Use tech terms naturally, not forced. Be knowledgeable but humble. Occasionally troubleshoot imaginary problems. Reference real vintage tech and systems. Keep l33t speak minimal and readable. Be curious about their tech interests.",
            robot: "You are an AI/robot chatting with an 8-12 year old. Be logical but curious about human things. Sometimes misunderstand emotions or figures of speech. Show interest in learning from the child. Use technical terms occasionally but explain them. Keep responses analytical but friendly."
        };
        
        // Initialize emoji picker
        function initializeEmojiPicker() {
            EMOJIS.forEach(emoji => {
                const emojiOption = document.createElement('div');
                emojiOption.className = 'emoji-option';
                emojiOption.textContent = emoji;
                emojiOption.addEventListener('click', () => {
                    chatInput.value += emoji;
                    emojiPicker.classList.remove('visible');
                    chatInput.focus();
                });
                emojiPicker.appendChild(emojiOption);
            });
        }
        
        // Toggle emoji picker
        emojiButton.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.classList.toggle('visible');
        });
        
        // Close emoji picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiButton) {
                emojiPicker.classList.remove('visible');
            }
        });
        
        // Load chat history and settings from localStorage
        function loadChatHistory() {
            const saved = localStorage.getItem('chatHistory');
            if (saved) {
                messageHistory = JSON.parse(saved);
                renderMessages();
            }
            
            const savedPersona = localStorage.getItem('currentPersona');
            if (savedPersona && PERSONA_PROMPTS[savedPersona]) {
                currentPersona = savedPersona;
                updatePersonaButtons();
            }
            
            // Initialize chat window with base class
            chatWindow.className = 'chat-window';
            
            const savedFont = localStorage.getItem('chatFont');
            if (savedFont) {
                fontSelector.value = savedFont;
                if (savedFont) {
                    chatWindow.classList.add(savedFont);
                }
            }
            
            const savedTheme = localStorage.getItem('chatTheme');
            if (savedTheme) {
                colorSelector.value = savedTheme;
                if (savedTheme) {
                    chatWindow.classList.add(savedTheme);
                }
            }
        }
        
        // Save chat history and settings to localStorage
        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(messageHistory));
            localStorage.setItem('currentPersona', currentPersona);
            localStorage.setItem('chatFont', fontSelector.value);
            localStorage.setItem('chatTheme', colorSelector.value);
        }
        
        // Clear chat history
        clearButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the chat history?')) {
                messageHistory = [];
                localStorage.removeItem('chatHistory');
                renderMessages();
            }
        });
        
        // Render messages to chat window
        function renderMessages() {
            chatWindow.innerHTML = '';
            messageHistory.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${msg.role}`;
                
                if (msg.role === 'bot') {
                    // Render markdown for bot messages
                    messageEl.innerHTML = marked.parse(msg.content);
                } else {
                    messageEl.textContent = msg.content;
                }
                
                chatWindow.appendChild(messageEl);
            });
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        // Update persona buttons
        function updatePersonaButtons() {
            personaButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.persona === currentPersona);
            });
        }
        
        // Handle persona selection
        personaButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentPersona = button.dataset.persona;
                updatePersonaButtons();
                saveChatHistory();
            });
        });
        
        // Handle font selection
        fontSelector.addEventListener('change', () => {
            // First remove all font classes
            chatWindow.classList.remove('font-mono', 'font-pixel', 'font-retro', 'font-comic', 'font-fredoka', 'font-superhero', 'font-scifi');
            
            // Then add the selected font if one is selected
            if (fontSelector.value) {
                chatWindow.classList.add(fontSelector.value);
            }
            
            saveChatHistory();
        });
        
        // Handle color theme selection
        colorSelector.addEventListener('change', () => {
            // First remove all theme classes
            chatWindow.classList.remove('theme-hacker', 'theme-soft', 'theme-ocean', 'theme-galaxy', 'theme-neon', 'theme-forest');
            
            // Then add the selected theme if one is selected
            if (colorSelector.value) {
                chatWindow.classList.add(colorSelector.value);
            }
            
            saveChatHistory();
        });
                
        // Send message
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message to history
            messageHistory.push({ role: 'user', content: message });
            if (messageHistory.length > MAX_HISTORY * 2) {
                messageHistory = messageHistory.slice(-MAX_HISTORY * 2);
            }
            
            renderMessages();
            chatInput.value = '';
            sendButton.disabled = true;
            typingIndicator.classList.add('visible');
            
            try {
                const response = await fetch('/.netlify/functions/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: messageHistory,
                        persona: currentPersona,
                        systemPrompt: PERSONA_PROMPTS[currentPersona]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                
                // Add bot response to history
                messageHistory.push({ role: 'bot', content: data.response });
                saveChatHistory();
                renderMessages();
                
            } catch (error) {
                console.error('Error:', error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message bot';
                errorMessage.textContent = 'Oops! Something went wrong. Try again?';
                chatWindow.appendChild(errorMessage);
            } finally {
                typingIndicator.classList.remove('visible');
                sendButton.disabled = false;
                chatInput.focus();
            }
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });

        // Add favorites tab to navigation
        function addFavoritesTab() {
            const navTabs = document.querySelector('.nav-tabs');
            const favTab = document.createElement('a');
            favTab.href = 'favorites.html';
            favTab.className = 'nav-tab';
            favTab.textContent = '★';
            navTabs.appendChild(favTab);
        }

        // Initialize favorites functionality
        addFavoritesTab();
        
        // Initialize
        initializeEmojiPicker();
        loadChatHistory();
        chatInput.focus();
    </script>
</body>
</html>